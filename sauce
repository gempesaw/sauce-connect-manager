#! /bin/bash

: ${SAUCE_USER:?"Need to set SAUCE_USER:

    export SAUCE_USER=<your sauce username>"}
: ${SAUCE_KEY:?"Need to set SAUCE_API_KEY:

    export SAUCE_KEY=<your sauce api key>"}
MAIL=your@email.com

COMMAND=0
if [ "$1" == "update" ] ; then
    COMMAND=1
    killall java -u $LOGNAME
    sleep 10
    rm -rf $HOME/sauceConnect
    cd
    mkdir $HOME/sauceConnect
    cd $HOME/sauceConnect
    curl http://saucelabs.com/downloads/Sauce-Connect-latest.zip -o sauce-connect-latest.zip
    unzip sauce-connect-latest.zip
    rm sauce-connect-latest.zip
fi

if [ "$1" == "restart" ] ; then
    COMMAND=1
    echo "Killing all java processes belonging to $LOGNAME and waiting for them to shut down";
    killall java -u $LOGNAME
    sleep 15
    echo "Starting a new tunnel.";
    nohup /usr/bin/java -jar $HOME/sauceConnect/Sauce-Connect.jar --shared-tunnel $SAUCE_USER $SAUCE_KEY > $HOME/$SAUCE_USER &
fi

if [ "$1" == "crontab" ] ; then
    COMMAND=1
    (echo "MAILTO=\"$MAIL\"

00 20 * * * rm $HOME/sauce_connect.log $HOME/$SAUCE_USER > /dev/null
00 20 * * * /home/qa/sauce restart
01 20 * * * /home/qa/sauce status
*/10 * * * * /usr/bin/perl $HOME/maintainTunnel.pl $SAUCE_USER $SAUCE_KEY restart >> $HOME/maintainLog

") | crontab
fi

if [ "$1" == "status" ] ; then
    COMMAND=1
    echo "Sauce Tunnel Status: "
    perl $HOME/maintainTunnel.pl $SAUCE_USER $SAUCE_KEY

    echo "
Running Sauce Tunnels:"
    ps aux | grep Sauce | grep -v grep

    echo "
Current Crontab:"
    (crontab -l) | cat
fi

HELP="Usage: ./sauce COMMAND
Control your sauce tunnel.

The commands you can use are:

   help         Show this help

   restart      Kill all java processes belonging to the user and
                nohup the sauce tunnel, stdout redirected to
                $HOME/$SAUCE_USER

   crontab      Write over the crontab with the default Sauce-tasks
                only crontab

   status       View the running Sauce tunnels and the current crontab

   update       Download a new version of the Sauce Connect jar in
                ~/sauceConnect. You'll want to run ./sauce restart
                after this to start the tunnel again
"

if [ "$1" == "help" ] || [ "$1" == "--help" ] || [ "$1" == "-h" ] || [ $COMMAND -eq 0 ] ; then
    echo "$HELP" > $HOME/README
    echo "$HELP"
fi